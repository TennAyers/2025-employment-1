@{
    ViewData["Title"] = "Home Page";
}
<div class="text-center">
    <h1 class="display-4">こんにちはWebアプリケーション！</h1>
    <div class="text-center">
    <h1 class="display-4">ようこそ</h1>
    
    <div id="user-info" style="display: none;">
        <p><img id="user-photo" src="" width="50" style="border-radius: 50%;"> <span id="user-name"></span> さん、こんにちは！</p>
        <button id="logout-button" class="btn btn-secondary">ログアウト</button>
    </div>

<div class="text-center">
    <h1 class="display-4">顔認識 AR風デモ</h1>
    
    <script defer src="~/js/face-api.js"></script>

    <div style="position: relative; width: 640px; margin: auto;">
        <video id="video" width="640" height="480" autoplay muted></video>
        <canvas id="overlay" style="position: absolute; top: 0; left: 0;"></canvas>
    </div>

    <div>
        <h3>顔を登録</h3>
        <input type="text" id="regName" placeholder="名前 (例: 山田太郎)">
        <input type="text" id="regAffiliation" placeholder="所属 (例: A株式会社)">
        <textarea id="regNotes" placeholder="メモ..."></textarea>
        <button id="registerButton">この顔で登録</button>
        <div id="status"></div>
    </div>
</div>
@section Scripts {
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    let lastDetectedDescriptor = null; // 登録用に最後に検出した顔特徴量を保持

    // ----- face-api.js の初期化 (変更なし) -----
    async function loadAIModels() {
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri('/js/models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('/js/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('/js/models');
            
            console.log("AIモデル読み込み完了");
            startFaceDetectionLoop();
            
        } catch (err) {
            console.error("AIモデルの読み込みに失敗しました:", err);
            statusEl.innerText = "AIモデルの読み込みに失敗。F12でコンソールを確認し '404 (Not Found)' が出ていないか確認してください。";
        }
    }

    // ----- カメラの起動 (変更なし) -----
    async function startVideo() {
        console.log("カメラ起動を試みます...");
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            console.log("カメラ起動成功。映像をセットしました。");
        } catch (err) {
            console.error("カメラの起動に失敗しました:", err);
            statusEl.innerText = "カメラの許可がブロックされました。ブラウザのアドレスバーの左側にある鍵マークを確認してください。";
        }
    }

    // ----- リアルタイム顔認識ループ -----
    async function detectFaceTask() {
        
        if (!video || video.readyState < 4) { 
            requestAnimationFrame(detectFaceTask);
            return; 
        }

        try {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const ONLY_ONE_FACE_DETECTED = 1;

            if (detections.length === ONLY_ONE_FACE_DETECTED) {
                const detection = detections[0];
                const descriptor = detection.descriptor;

                // ▼▼▼ 修正点 1 ▼▼▼
                // 検出が成功したら、常に lastDetectedDescriptor を上書き更新する
                // (これで、ユーザーがボタンを押す瞬間にデータが消えなくなります)
                lastDetectedDescriptor = descriptor; 

                // ★ C# API (識別) を呼び出す (変更なし)
                const response = await fetch('/api/face/identify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Descriptor: JSON.stringify(Array.from(descriptor)) }) 
                });

                if (!response.ok) {
                    console.error("APIエラー:", response.status, await response.text());
                    statusEl.innerText = `APIエラー: ${response.status}。 C#サーバー側のログを確認してください。`;
                } else {
                    const result = await response.json();
                    // 認識結果をAR風に描画 (変更なし)
                    const box = detection.detection.box;
                    ctx.strokeStyle = 'blue';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                    
                    ctx.fillStyle = 'blue';
                    ctx.font = '20px Arial';
                    ctx.fillText(result.name, box.x, box.y - 10); 
                    if (result.success && result.affiliation) {
                        ctx.fillText(result.affiliation, box.x, box.y + box.height + 20);
                    }
                }
            } else {
                // ▼▼▼ 修正点 2 ▼▼▼
                // 顔が0個または複数でも、lastDetectedDescriptor を null に「しない」
                // (何もしない。最後に検出した顔データを保持し続ける)
            }
        
        } catch (err) {
            console.error("顔認識ループ（requestAnimationFrame）内でエラー:", err);
        }

        requestAnimationFrame(detectFaceTask);
    }

    // ループ開始用の関数 (変更なし)
    function startFaceDetectionLoop() {
        console.log("顔認識ループを開始します。");
        canvas.width = video.width;
        canvas.height = video.height;
        requestAnimationFrame(detectFaceTask);
    }
    

    // ----- 登録ボタンの処理 -----
    document.getElementById('registerButton').addEventListener('click', async () => {
        if (!lastDetectedDescriptor) {
            statusEl.innerText = "登録する顔が検出されていません。(カメラに顔を1つだけ写してください)";
            return;
        }
        const name = document.getElementById('regName').value;
        const affiliation = document.getElementById('regAffiliation').value;
        const notes = document.getElementById('regNotes').value;
        
        const memoData = {
            Name: name,
            Affiliation: affiliation,
            Notes: notes,
            FaceDescriptorJson: JSON.stringify(Array.from(lastDetectedDescriptor)) 
        };

        statusEl.innerText = "登録中...";

        try {
            const response = await fetch('/api/face/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            });

            if (!response.ok) {
                statusEl.innerText = `登録APIエラー: ${response.status}。 C#サーバー側のログを確認してください。`;
                return;
            }

            const result = await response.json();
            if(result.success) {
                statusEl.innerText = `「${result.name}」さんを登録しました。`;

                // ▼▼▼ 修正点 3 ▼▼▼
                // 登録が成功したら、保持していた顔データとフォームをクリアする
                lastDetectedDescriptor = null;
                document.getElementById('regName').value = '';
                document.getElementById('regAffiliation').value = '';
                document.getElementById('regNotes').value = '';

            } else {
                statusEl.innerText = `登録に失敗しました: ${result.message}`;
            }
        } catch (err) {
            console.error("登録処理中にエラー:", err);
            statusEl.innerText = "登録処理中に通信エラーが発生しました。";
        }
    });

    // ----- 実行開始部分 (変更なし) -----
    startVideo();
    video.addEventListener('play', () => {
        console.log("ビデオ再生が開始されました。AIモデルの読み込みを開始します。");
        loadAIModels();
    });

</script>
}